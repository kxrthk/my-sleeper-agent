name: Hourly Sentinel

on:
  schedule:
    # Runs at :15 past every hour during NSE Market Hours (Mon-Fri)
    # 3:45 UTC (9:15 AM IST) to 10:15 UTC (3:45 PM IST)
    - cron: '15 4-10 * * 1-5'
  workflow_dispatch: # Allows you to trigger it manually for testing

permissions:
  contents: write # Essential for the bot to save bot_brain.json

jobs:
  run-sentinel:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4 # Updated to v4 for better performance
        with:
          fetch-depth: 0 # Fetches all history so git push never fails

      - name: 2. Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Caches dependencies so the bot wakes up faster

      - name: 3. Install Requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Execute Sleeper Agent
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python daily_bot.py

      - name: 5. Force-Sync Memory (Self-Healing Push)
        run: |
          git config --global user.name "Sleeper Agent"
          git config --global user.email "agent@sentinel.com"
          
          # Pull latest changes first to prevent "Rejected Push" errors
          git pull origin main --rebase
          
          # Add only the memory files
          git add trading_journal.csv bot_brain.json
          
          # Only commit if the files actually changed
          if git diff --staged --quiet; then
            echo "No changes in memory. Skipping commit."
          else
            git commit -m "ðŸ§  Agent Memory Update: $(date +'%Y-%m-%d %H:%M')"
            git push origin main
          fi
